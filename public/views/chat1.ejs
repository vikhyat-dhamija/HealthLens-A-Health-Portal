<!DOCTYPE html>
<head>
    <script src="https://kit.fontawesome.com/221ff96759.js" crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body { font: 13px Helvetica, Arial; }
form { background: #fff; padding: 3px; position: fixed; bottom: 0; width: 100%; border-color: #000; border-top-style: solid; border-top-width: 1px;}
form input { border-style: solid; border-width: 1px; padding: 10px; width: 85%; margin-right: .5%; }
form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; margin-left: 2%; }
#messages { list-style-type: none; margin: 0; padding: 0; }
#messages li { padding: 5px 10px; }
#messages li:nth-child(odd) { background: #eee; }

</style>

</head>

<body>

  
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<script src="https://http://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>    

</script>

<div class="row">
    <div class="col-lg-12">
       <nav class="navbar navbar-expand-lg navbar-dark bg-primary" >
           <ul class="nav justify-content-end"> 
              <li class="nav-item" class="nav justify-content-end">   
                  <a class="navbar-brand" href="#">Health Lens</a>
                  </li>
          <% var username %>
          <li class="nav-item" class="nav justify-content-end">
            <i class="fas fa-user fa-2x"></i>
              <label id="user_name" value='<%= username %>'><%= username %></label>
          </li>
            <li class="nav-item" class="nav justify-content-end" float='right'> 
           <form class="form-inline my-2 my-lg-0" >
            <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
           </form>
           </li>
           <li class="nav-item" class="nav justify-content-end" float='right'>
           <input type="button" id="log_out" name="log_out" value="LogOut" class="btn btn-primary" > </input>
          </li>
          
          </ul>
        </div>
      </nav>
</div>

<div class="row" id="messagearea">


</div>


<div class="row">
    <div class="col-lg-12">
    <ul id="messages"></ul>

    <form action="/" method="POST" id="chatForm">

      <input id="txt" autocomplete="off" autofocus="on" placeholder="type your message here..." /><button>Send</button>

    </form>
</div>  
</div>      


<script
src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.0.1/mustache.min.js">
</script>

<script
src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js">
</script>

<script
src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.6.0/qs.min.js">
</script>

<script>
 function readCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}   
var token=readCookie('auth');

var el=document.getElementById('user_name');
var username = (el.innerText || el.textContent);
//for checking that we are getting the username correctly
console.log(username)

//const io = require('socket.io-client');

const socket = io('http://localhost:3000');

a_health=document.getElementById('health');

a_cpmparison=document.getElementById('comparison');

a_useful=document.getElementById('useful');


document.querySelector('#log_out').addEventListener('click',()=>{


document.location.assign('/sign_out/'+token)

})

//emit the username to the server
socket.emit('username', username);


// append the chat text message

socket.on('chat_message', function(msg){

$('#messages').append($('<li>').html(msg));

});



// append text if someone is online and hence its event is appended once the user enters the chat page or leave the chat page
socket.on('is_online', function(username) {

$('#messages').append($('<li>').html(username));

});


// submit text message without reload/refresh the page kind of ajax using jquery
$('form').submit(function(e){

    e.preventDefault(); // prevents page reloading   
    socket.emit('chat_message', $('#txt').val());
    $('#txt').val('');

    return false;

});

//on window load fetch all the chats messages for being displayed on the browser for display
window.onload=()=>{

fetch('/chatmessages/'+token).then(response => response.json()).then((data)=> 
{
    var i=0
    var chatar=document.getElementById('messages');
    for(i=0; i < data.messages.length ; i++){
        chatar.innerHTML+=('<li>'+'<strong>' + data.messages[i].username + '</strong>: ' + data.messages[i].messages+'</li>')
    }

})

}

</script>
</body>